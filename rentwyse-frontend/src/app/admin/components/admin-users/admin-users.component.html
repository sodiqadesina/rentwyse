<div class="users-page">
  <!-- Header -->
  <div class="users-header">
    <div>
      <h2>Users</h2>
      <p class="subtitle">
        Monitor platform accounts, roles, and verification status.
      </p>
    </div>

    <div class="header-actions">
      <button
        mat-stroked-button
        color="primary"
        class="refresh-btn"
        (click)="onRefresh()"
      >
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </div>
  </div>

  <!-- Metrics -->
  <div class="metrics-row">
    <mat-card class="metric-card">
      <div class="metric-label">Total Users</div>
      <div class="metric-value">{{ stats.total }}</div>
      <div class="metric-trend neutral">
        <mat-icon>group</mat-icon>
        Platform-wide
      </div>
    </mat-card>

    <mat-card class="metric-card">
      <div class="metric-label">Active</div>
      <div class="metric-value">{{ stats.active }}</div>
      <div class="metric-trend positive">
        <mat-icon>check_circle</mat-icon>
        Can sign in
      </div>
    </mat-card>

    <mat-card class="metric-card">
      <div class="metric-label">Banned</div>
      <div class="metric-value">{{ stats.banned }}</div>
      <div class="metric-trend negative">
        <mat-icon>block</mat-icon>
        Access revoked
      </div>
    </mat-card>

    <mat-card class="metric-card">
      <div class="metric-label">Admins</div>
      <div class="metric-value">{{ stats.admins }}</div>
      <div class="metric-trend highlight">
        <mat-icon>admin_panel_settings</mat-icon>
        Elevated access
      </div>
    </mat-card>
  </div>

  <!-- Filters -->
  <!-- USERS FILTER BAR (PURE HTML/CSS) -->
  <div class="users-filters">
    <!-- SEARCH -->
    <div class="filter-field filter-field--grow">
      <label class="filter-label">Search (username / email)</label>
      <div class="filter-control">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (keyup.enter)="onApplyFilters()"
          placeholder="e.g. sina or sina@example.com"
        />
      </div>
    </div>

    <!-- STATUS -->
    <div class="filter-field">
      <label class="filter-label">Status</label>
      <div class="filter-control">
        <select [(ngModel)]="filterStatus">
          <option value="">All</option>
          <option value="active">Active</option>
          <option value="banned">Banned</option>
        </select>
      </div>
    </div>

    <!-- ROLE -->
    <div class="filter-field">
      <label class="filter-label">Role</label>
      <div class="filter-control">
        <select [(ngModel)]="filterRole">
          <option value="">All</option>
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
      </div>
    </div>

    <!-- BUTTONS -->
    <div class="filter-actions">
      <button
        type="button"
        class="filter-btn filter-btn--primary"
        (click)="onApplyFilters()"
      >
        Apply
      </button>

      <button
        type="button"
        class="filter-btn filter-btn--ghost"
        (click)="onClearFilters()"
      >
        Reset
      </button>
    </div>
  </div>



  <!-- Table -->
  <mat-card class="table-card">
    <div class="table-toolbar">
      <div class="toolbar-left">
        <span class="toolbar-title">User List</span>
        <span class="toolbar-subtitle">
          Showing {{ dataSource.data.length }} of {{ totalUsers }}
        </span>
      </div>

      <mat-progress-spinner
        *ngIf="isLoading"
        diameter="26"
        mode="indeterminate"
      ></mat-progress-spinner>
    </div>

    <div class="table-container" *ngIf="dataSource.data.length; else emptyState">
      <table mat-table [dataSource]="dataSource" class="users-table">
        <!-- Username -->
        <ng-container matColumnDef="username">
          <th mat-header-cell *matHeaderCellDef> User </th>
          <td mat-cell *matCellDef="let user">
            <div class="user-main">
              <div class="avatar">
                {{ user.username?.charAt(0) | uppercase }}
              </div>
              <div class="user-text">
                <div class="user-name">{{ user.username }}</div>
                <div class="user-id">ID: {{ user._id | slice:0:8 }}…</div>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Email -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef> Email </th>
          <td mat-cell *matCellDef="let user">
            <span class="email-text">{{ user.email }}</span>
          </td>
        </ng-container>

        <!-- City -->
        <ng-container matColumnDef="city">
          <th mat-header-cell *matHeaderCellDef> City </th>
          <td mat-cell *matCellDef="let user">
            {{ user.city || "—" }}
          </td>
        </ng-container>

        <!-- Role -->
        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef> Role </th>
          <td mat-cell *matCellDef="let user">
            <span
              class="pill pill-role"
              [ngClass]="{
                'pill-admin': user.role === 'admin',
                'pill-user': user.role === 'user'
              }"
            >
              <mat-icon class="pill-icon">
                {{ user.role === "admin" ? "admin_panel_settings" : "person" }}
              </mat-icon>
              <span>{{ user.role | titlecase }}</span>
            </span>
          </td>
        </ng-container>

        <!-- Status -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef> Status </th>
          <td mat-cell *matCellDef="let user">
            <span
              class="pill pill-status"
              [ngClass]="{
                'pill-active': user.status === 'active',
                'pill-banned': user.status === 'banned'
              }"
            >
              <mat-icon class="pill-icon">
                {{ user.status === "active" ? "check_circle" : "block" }}
              </mat-icon>
              <span>{{ user.status | titlecase }}</span>
            </span>
          </td>
        </ng-container>

        <!-- KYC -->
        <ng-container matColumnDef="kycStatus">
          <th mat-header-cell *matHeaderCellDef> KYC </th>
          <td mat-cell *matCellDef="let user">
            <span
              class="kyc-pill"
              [ngClass]="{
                'kyc-approved': user.kycStatus === 'approved',
                'kyc-pending': user.kycStatus === 'pending',
                'kyc-rejected': user.kycStatus === 'rejected'
              }"
            >
              {{ (user.kycStatus || "not_submitted") | uppercase }}
            </span>
          </td>
        </ng-container>

        <!-- Created At -->
        <ng-container matColumnDef="createdAt">
          <th mat-header-cell *matHeaderCellDef> Joined </th>
          <td mat-cell *matCellDef="let user">
            {{ user.createdAt | date: "MMM d, y" }}
          </td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> Actions </th>
          <td mat-cell *matCellDef="let user">
            <div class="actions-group">
              <button
                mat-stroked-button
                color="warn"
                class="small-btn"
                (click)="toggleStatus(user)"
              >
                {{ user.status === "active" ? "Ban" : "Unban" }}
              </button>

              <button
                mat-stroked-button
                color="primary"
                class="small-btn"
                (click)="toggleRole(user)"
              >
                {{
                  user.role === "admin"
                    ? "Demote to User"
                    : "Promote to Admin"
                }}
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>

    <!-- Empty state -->
    <ng-template #emptyState>
      <div class="empty-state">
        <mat-icon>people_outline</mat-icon>
        <h3>No users found</h3>
        <p>Try adjusting your filters or search query.</p>
        <button mat-stroked-button color="primary" (click)="onClearFilters()">
          Reset filters
        </button>
      </div>
    </ng-template>

    <!-- Paginator -->
    <mat-paginator
      [length]="totalUsers"
      [pageSize]="pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="[5, 10, 20, 50]"
      (page)="onPageChange($event)"
    >
    </mat-paginator>
  </mat-card>
</div>
